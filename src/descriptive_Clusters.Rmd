---
title: "descriptive_Clusters"
date: "`r format(Sys.time(), '%d %B, %Y, %H:%M')`"
output: 
  html_document:
    df_print: paged
    toc: true
    toc_float: true
knit: (function(inputFile, encoding) {
    rmarkdown::render(inputFile, encoding = encoding, output_dir = "../output")
  })
---

```{r settings, include = FALSE}
library(tsbox)
library(ggplot2)
library(tidyverse)
library(geojsonio)
library(tsfeatures)
library(rprojroot)
library(openair)
library(reshape2)
library(lubridate)
library(rgdal)
library(maptools)
library(sp)
library(rgeos)
library(classInt)
library(RColorBrewer)
library(knitr)
library(rprojroot)
library(viridis)
library(hrbrthemes)

# This is the project path
path <- find_rstudio_root_file()
```


```{r include = FALSE}

# load the data created by Data_Spatial.Rmd and ts_clusters.Rmd

LAD.cluster <- paste(path, "/data/temp/clusters_nodiff.csv", sep = "")

clusters <- read_csv(LAD.cluster)

path.data <- paste(path, "/data/temp/TSbb19_20sp.csv", sep = "")

TSbb19_20sp <- read_csv(path.data)

#split out 2020 before join to clusters to create descriptives
TS2020 <- selectByDate(TSbb19_20sp, year = 2020) 
TS2019 <- selectByDate(TSbb19_20sp, year = 2019)

#join clusters to TS2020
names(clusters) [1] <- "LAD19NM"
TS2020 <- left_join(TS2020, clusters)
TS2019 <- left_join(TS2019, clusters)
#remove NAs? - otherwise cannot create unified dataframes for below stats

#summarise by LADs per cluster and Total tests / Mean speed per cluster
#Test Frequency cluster
LAD.cluster.tests <- clusters %>%
  group_by(cluster.tests) %>%
  summarise(n.LADs = n())
LAD.cluster.testsTotal <- TS2020 %>%
  group_by(cluster.tests) %>%
  summarise(n.cluster = n()) 
LAD.cluster.tests19 <- TS2019 %>%
  group_by(cluster.tests) %>%
  summarise(n.cluster19 = n()) 
LAD.cluster.tests <- cbind(LAD.cluster.tests, LAD.cluster.testsTotal[,2], LAD.cluster.tests19[,2])
LAD.cluster.tests$n.20_19.diff <- LAD.cluster.tests$n.cluster - LAD.cluster.tests$n.cluster19
LAD.cluster.tests$perCent.change <- LAD.cluster.tests$n.20_19.diff/
  LAD.cluster.tests$n.cluster19
LAD.cluster.tests$perCent.change <- paste(round(100*LAD.cluster.tests$perCent.change, 2), "%", sep="")
#Upload Speed Clusters
LAD.cluster.up <- clusters %>%
  group_by(cluster.up) %>%
  summarise(up.LADs = n())
LAD.cluster.upMean <- summarise(group_by(TS2020, cluster.up),
  mean(speedup))
LAD.cluster.upSD <- summarise(group_by(TS2020, cluster.up),
  sd(speedup))
LAD.cluster.upAM <- summarise(group_by(TS2020[which(TS2020$hour == 9 | TS2020$hour == 10),], cluster.up), mean(speedup))
LAD.cluster.upPM <- summarise(group_by(TS2020[which(TS2020$hour == 19 | TS2020$hour == 20),], cluster.up), mean(speedup))
LAD.cluster.up <- cbind(LAD.cluster.up, LAD.cluster.upMean[,2], LAD.cluster.upSD[,2], LAD.cluster.upAM[,2], LAD.cluster.upPM[,2])
names(LAD.cluster.up) [3:6] <- c("upMean", "upSD", "upAMmean",
                                 "upPMmean")
#Download speed clusters  
LAD.cluster.down <- clusters %>%
  group_by(cluster.down) %>%
  summarise(down.LADs = n())
LAD.cluster.downMean <- summarise(group_by(TS2020, cluster.down),
  mean(speeddown))
LAD.cluster.downSD <- summarise(group_by(TS2020, cluster.down),
  sd(speeddown))
LAD.cluster.downAM <- summarise(group_by(TS2020[which(TS2020$hour == 9 | TS2020$hour == 10),], cluster.down), mean(speeddown))
LAD.cluster.downPM <- summarise(group_by(TS2020[which(TS2020$hour == 19 | TS2020$hour == 20),], cluster.down), mean(speeddown))
LAD.cluster.down <- cbind(LAD.cluster.down, LAD.cluster.downMean[,2], LAD.cluster.downSD[,2], LAD.cluster.downAM[,2], LAD.cluster.downPM[,2])
names(LAD.cluster.down)[3:6] <- c("downMean", "downSD", "downAMmean",
                                  "downPMmean")
# commented to run the script
# LAD.cluster.diffUp <- clusters %>%
#   group_by(cluster.up.diff) %>%
#   summarise(diffUp.LADs = n())
# LAD.cluster.diffDown <- clusters %>%
#   group_by(cluster.down.diff) %>%
#   summarise(diffDown.LADs = n())

#write csvs to outputs
out.clustersLAD <- paste(path, "./data/temp/LAD.cluster.tests.csv", sep = "")
write_csv(LAD.cluster.tests, out.clustersLAD)
out.clustersLADup <- paste(path, "./data/temp/LAD.cluster.up.csv", sep = "")
write_csv(LAD.cluster.up, out.clustersLADup)
out.clustersLADdown <- paste(path, "./data/temp/LAD.cluster.down.csv", sep = "")
write_csv(LAD.cluster.down, out.clustersLADdown)

```

As people came to rely more on their broadband services, it is unsurprising that the rate of testing increased in 2020 compared to 2019. This increase was greatest in cluster 2, where 56% more tests were run compared to the same period in 2019. Cluster 2 also has the most local authorities, 148, so the sum of tests run in all these authorities is much higher than in all the other clusters, both in 2019 and 2020. Cluster 1 has the second most local authorities, with 93, but the frequency of testing in these authorities is much lower in 2019 and 2020 and there was the lowest rate of increase between the two time periods at just 33%. In comparison, cluster 5 has the fewest local authorities, at 28, but the second highest total number of tests and the second largest increase in testing between 2019 and 2020, at 52%. A possible explanation is that cluster 5 contains some of the most populous local authorities in the country, including the cities of Birmingham, Manchester, Leeds, Sheffield, Glasgow and Edinburgh. However, this cluster also includes large rural counties, such as Cornwall and Northumberland.
Yet the temporal profile in 2020 is very different to 2019, as can be seen in graphs [.] and [.]. The number of broadband speed tests run in local authorities in cluster 2 peaked each Monday to Thursday in the hour 19.00-19.59 in March through May 2019. On Fridays, the peak was slightly earlier. A similar, although less stark pattern could be seen in the other clusters, along with much smaller peaks around the beginning of the working day, at either 9.00-9.59 or 10.00-10.59. In comparison, the daily profile of broadband speed testing in 2020 is flatter, with less variation hour to hour. Although there is still an identifiable evening peak for almost all days of the week and all clusters, it is much less pronounced throughout, there is less of a gap between the number of tests in the morning peak and the evening peak, and there is less of a dip in testing in the middle of the day. All this suggests that more of the additional testing generated in 2020 compared to 2019 is occurring outside the traditional peak in the evening at streaming primetime.  Moreover, this is particularly noticeable for cluster 2, but the change is less pronounced for cluster 5, perhaps because of the diversity of urban and rural populations represented in cluster 5. The graphs also show that Cluster 1, with the lowest increase in testing, falls from the middle position in terms of total number of tests to the second from bottom.
For upload speeds, 345 of 382 local authorities fall into cluster 6 or cluster 9. Graph [.] shows that both of these clusters have relatively similar temporal profiles, with relatively stable speeds. However, the upload speeds at all times for cluster 9 are substantially higher than for cluster 6. This difference is reflected not only in the mean speeds for these clusters for the whole sample, but also the mean upload speeds in evening peak period from 19:00-20:59 and the morning peak from 9:00-10:59. Which sort of areas are benefitting from these higher speeds? The 115 Local Authority areas are mostly in urban or suburban areas, including 13 London Boroughs (of 32), 8 of the 10 local authorities of Greater Manchester, 5 of the 7 constituent authorities of the West Midlands Combined Authority, as well as cities like Glasgow, Leicester, Nottingham, Sheffield, and the Portsmouth and Southampton conurbation. There are also some notable medium-sized cities, including Aberdeen, Cardiff, Oxford, Milton Keynes, and York, as well as many suburban districts from the South East of England to South Tyneside. 
On the other hand, the 230 local authorities in cluster 6 still include urban areas, including Bristol, Liverpool and Leeds, and many suburban areas. However, it also includes some of the most rural areas in the country, and could be more seen as a typical level of service for upload speeds, rather than being particularly slow. The differences between morning and evening upload speeds for both clusters are minimal, at 1% slower in the morning in cluster 9 and 4% slower in cluster 6. This is an indication of the reliability of broadband services in places in both clusters, and suggests that upload speeds have generally been robust throughout the study period. The exceptions can be found in seven of the eight much smaller clusters of between 1 and 10 local authority districts, where the standard deviation from mean speeds is between 3% and 14% greater than in cluster 6. The temporal profiles on Graph [.] for the three of those clusters with more than 5 local authorities also shows that speeds are far from dependable in these clusters. Furthermore, AM peak upload speeds are between 6% and 18% slower than PM peak upload speeds in the 35 local authorities in these seven clusters, although the mean speeds for each cluster are higher than cluster 6. Included in this eclectic group are central London borough of Westminster and the remote Isles of Scilly, and even the largest of these clusters includes a Surrey district on the outskirts of London, the West Wales authority of Ceredigion, and the northern market town of Darlington.
Download speeds are the most commonly used measure of the quality and reliability of broadband services. They also vary the most, with standard deviations in speed tending to be in a similar range to the mean speeds for each cluster, compared to upload speeds, where standard deviations are half to two thirds the level of the mean speeds. This temporal variation can be seen in Graph [.], which shows the 10 of 20 clusters with over five local authorities in them. The largest of these 10 clusters, number 19 with 123 Local Authorities, as well as cluster 1 with 16 Local Authorities have lower mean speeds than the other clusters, and this is consistent throughout the temporal profile on the graph. However, this means they also have lower standard deviations, without such extreme peaks and troughs as, for example, clusters 7, 9 and 11, with 36 Local Authorities. What is of greater interest, however, is where download speeds are slower in the morning peak when broadband is more likely to be used for work purposes than in the evening peak. This difference is most stark in some of the smaller clusters, although since there are only 11 Local Authorities in these clusters even added together, their inclusion in these clusters may be more a reflection of quite localised issues. The largest two clusters of Local Authorities have 1-3% slower speeds in the AM peak, and a few clusters have faster download speeds in the AM peak. However, there are still 58 Local Authorities, including the 11 mentioned previously with download speeds at least 6% lower in the morning peak than in the evening peak.
Is the reduction in download speeds in the morning peak in more places than the reduction in upload speeds a result of ISP management to support reliable services for telecommuters? There are only eight Local Authorities where both upload and download speeds are more than 5% slower in the AM peak than the PM peak.

```{r }
#summarise test frequency clusters by hour of each weekday and plot
cluster.tests <- TS2020 %>%
  group_by(cluster.tests, weekday, hour) %>%
  summarise(n.tests = n())
names(cluster.tests)[1] <- "clusterID"
cluster.tests$clusterID <- as.factor(cluster.tests$clusterID)
#add fake dates for plotting
help.dates <- tibble(help.date.time = c(
  make_datetime(year = 2020, month = 3, day = 2),
  make_datetime(year = 2020, month = 3, day = 3),
  make_datetime(year = 2020, month = 3, day = 4),
  make_datetime(year = 2020, month = 3, day = 5),
  make_datetime(year = 2020, month = 3, day = 6)),
                     weekday = c("Mon", "Tue", "Wed", "Thu", "Fri"))
cluster.tests <- merge(cluster.tests, help.dates, by = "weekday")
cluster.tests$hour <- paste(cluster.tests$hour, ":00", sep="")
cluster.tests$help.date.time <- with(cluster.tests, as.POSIXct(paste(help.date.time, hour), format="%Y-%m-%d %H:%M"))
#plot cluster statistic for number tests
TestCluster <- ggplot(cluster.tests, aes(help.date.time, n.tests, 
                                         colour = clusterID))
TestCluster + geom_line() + labs(x = "Weekdays March-May 2020") + 
  scale_x_datetime(breaks = as.POSIXct(c("2020-03-02 15:00:00", 
                    "2020-03-03 15:00:00", "2020-03-04 15:00:00",
                    "2020-03-05 15:00:00", "2020-03-06 15:00:00"), 
                    labels = "%a"), labels = 
                     c("Mon", "Tues", "Weds", "Thurs", "Fri")) + geom_point()
#summarise test frequency clusters by hour of each weekday 2019 and plot
cluster.tests19 <- TS2019 %>%
  group_by(cluster.tests, weekday, hour) %>%
  summarise(n.tests = n())
names(cluster.tests19)[1] <- "clusterID"
cluster.tests19$clusterID <- as.factor(cluster.tests19$clusterID)
#add fake dates for plotting
help.dates <- tibble(help.date.time = c(
  make_datetime(year = 2019, month = 3, day = 4),
  make_datetime(year = 2019, month = 3, day = 5),
  make_datetime(year = 2019, month = 3, day = 6),
  make_datetime(year = 2019, month = 3, day = 7),
  make_datetime(year = 2019, month = 3, day = 8)),
                     weekday = c("Mon", "Tue", "Wed", "Thu", "Fri"))
cluster.tests19 <- merge(cluster.tests19, help.dates, by = "weekday")
cluster.tests19$hour <- paste(cluster.tests19$hour, ":00", sep="")
cluster.tests19$help.date.time <- with(cluster.tests19, as.POSIXct(paste(help.date.time, hour), format="%Y-%m-%d %H:%M"))
#plot cluster statistic for number tests
TestCluster19 <- ggplot(cluster.tests19, aes(help.date.time, n.tests, 
                                         colour = clusterID))
TestCluster19 + geom_line() + labs(x = "Weekdays March-May 2019") + 
  scale_x_datetime(breaks = as.POSIXct(c("2020-03-02 15:00:00", 
                    "2020-03-03 15:00:00", "2020-03-04 15:00:00",
                    "2020-03-05 15:00:00", "2020-03-06 15:00:00"), 
                    labels = "%a"), labels = 
                     c("Mon", "Tues", "Weds", "Thurs", "Fri")) + geom_point()
#summarise upload speed clusters by hour of each weekday and plot
cluster.up <- TS2020 %>%
  group_by(cluster.up, weekday, hour) %>%
  summarise(mean.up = mean(speedup))
names(cluster.up)[1] <- "clusterID"
names(LAD.cluster.up)[1] <- "clusterID"
cluster.up <- left_join(cluster.up, LAD.cluster.up)
cluster.up <- cluster.up[which(cluster.up$up.LADs > 5),]
cluster.up$clusterID <- as.factor(cluster.up$clusterID)
#add fake dates for plotting
help.dates <- tibble(help.date.time = c(
  make_datetime(year = 2020, month = 3, day = 2),
  make_datetime(year = 2020, month = 3, day = 3),
  make_datetime(year = 2020, month = 3, day = 4),
  make_datetime(year = 2020, month = 3, day = 5),
  make_datetime(year = 2020, month = 3, day = 6)),
                     weekday = c("Mon", "Tue", "Wed", "Thu", "Fri"))
cluster.up <- merge(cluster.up, help.dates, by = "weekday")
cluster.up$hour <- paste(cluster.up$hour, ":00", sep="")
cluster.up$help.date.time <- with(cluster.up, as.POSIXct(paste(help.date.time, hour), format="%Y-%m-%d %H:%M"))
#plot cluster statistic for mean upload speed
UpCluster <- ggplot(cluster.up, aes(help.date.time, mean.up, 
                                         colour = clusterID))
UpCluster + geom_line() + labs(x = "Weekdays March-May") + 
  scale_x_datetime(breaks = as.POSIXct(c("2020-03-02 15:00:00", 
                    "2020-03-03 15:00:00", "2020-03-04 15:00:00",
                    "2020-03-05 15:00:00", "2020-03-06 15:00:00"), 
                    labels = "%a"), labels = 
                     c("Mon", "Tues", "Weds", "Thurs", "Fri")) + geom_point()

#summarise download speed clusters by hour of each weekday and plot
cluster.down <- TS2020 %>%
  group_by(cluster.down, weekday, hour) %>%
  summarise(mean.down = mean(speeddown))
names(cluster.down)[1] <- "clusterID"
names(LAD.cluster.down)[1] <- "clusterID"
cluster.down <- left_join(cluster.down, LAD.cluster.down)
cluster.down <- cluster.down[which(cluster.down$down.LADs > 5),]
cluster.down$clusterID <- as.factor(cluster.down$clusterID)
#add fake dates for plotting
help.dates <- tibble(help.date.time = c(
  make_datetime(year = 2020, month = 3, day = 2),
  make_datetime(year = 2020, month = 3, day = 3),
  make_datetime(year = 2020, month = 3, day = 4),
  make_datetime(year = 2020, month = 3, day = 5),
  make_datetime(year = 2020, month = 3, day = 6)),
                     weekday = c("Mon", "Tue", "Wed", "Thu", "Fri"))
cluster.down <- merge(cluster.down, help.dates, by = "weekday")
cluster.down$hour <- paste(cluster.down$hour, ":00", sep="")
cluster.down$help.date.time <- with(cluster.down, as.POSIXct(paste(help.date.time, hour), format="%Y-%m-%d %H:%M"))
#plot cluster statistic for mean download speeds
TestCluster <- ggplot(cluster.down, aes(help.date.time, mean.down, 
                                         colour = clusterID))
TestCluster + geom_line() + labs(x = "Weekdays March-May") + 
  scale_x_datetime(breaks = as.POSIXct(c("2020-03-02 15:00:00", 
                    "2020-03-03 15:00:00", "2020-03-04 15:00:00",
                    "2020-03-05 15:00:00", "2020-03-06 15:00:00"), 
                    labels = "%a"), labels = 
                     c("Mon", "Tues", "Weds", "Thurs", "Fri")) + geom_point()

```

